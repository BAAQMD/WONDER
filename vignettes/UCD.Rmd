---
title: "Working with UCD Data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{UCD}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>")
```

```{r setup, include = FALSE}
library(WONDER)    # devtools::install_github("BAAQMD/WONDER")
library(ggtools)   # devtools::install_github("BAAQMD/ggtools")
library(exptools)  # devtools::install_github("BAAQMD/exptools")
library(openxlsx)
```

```{r extdata_path}
extdata_path <- function (...) {
  system.file("extdata", ..., package = "WONDER")
}
```

```{r SFBA_UCD_metadata}
SFBA_UCD_metadata <-
  crossing(
    timespan  = c("2003-2012", "2007-2016", "2011-2020"),
    geography = c("ByCounty", "Regional"),
    age       = c("AllAge", "ByAge5", "ByAge10"),
    variant   = c("Hispanic", "NH-ByRace", "AllRaceEth")) %>% 
  mutate(
    txt_fn    = str_glue("UCD-{timespan}-SFBA-{geography}-{age}-{variant}.txt"),
    txt_path  = map_chr(file.path("UCD", timespan, txt_fn), extdata_path)) %>% 
  filter(
    txt_path != "")
```

```{r SFBA_UCD_data}
SFBA_UCD_age_adjusted_data <-
  SFBA_UCD_metadata %>% 
  filter(age == "AllAge") %>% 
  mutate(data = map(txt_path, import_WONDER_UCD)) %>% 
  unnest(data) 
```

```{r fig_theme}
fig_theme <- 
  theme_simple() +
  theme_gridlines() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
  theme_remove("axis", c("ticks", "line"), c("x", "y"))
```

```{r raceeth_colors}
raceeth_colors <-
  RACEETH_COLORS %>%          # from the `exptools` package
  rename(NatAm = NatAmer) 

raceeth_colors[["(all)"]] <- gray(0) # black
```

## Charts (Age-Adjusted Rates)

```{r fig_description}
fig_description <-
  labs(
    title = str_glue("Mortality Across the Nine-County Bay Area"),
    subtitle = "Age-adjusted all-cause rates, with 95% confidence intervals",
    caption = str_glue(
      "Accessed at http://wonder.cdc.gov/ucd-icd10.html on Sep 16, 2024 1:44:39 PM",
      str_draft(),
      .sep = "\n"))
```

```{r make_figure_by_raceeth}
make_figure_by_raceeth <- function (.data, ..., rate_per = 100e3) {
  
  timespan_levels <-
    with(.data, sort(unique(timespan)))
  
  timespan_shapes <-
    scale_shape_discrete()$palette(length(timespan_levels))
  
  chart_data <-
    drop_units(.data) %>% 
    replace_na(
      list(
        cnty_name = "(average)", 
        pop_raceeth = "(all)")) %>% 
    mutate(
      cnty_name = fct_reorder(cnty_name, est(rate_adj)) %>% 
        fct_relevel("(average)", after = 9))
  
  chart_data %>% 
    ggplot(...) +
    aes(x = cnty_name, 
        shape = factor(timespan, levels = timespan_levels),
        alpha = I(0.8),
        y = est(rate_adj), 
        color = pop_raceeth,
        ymin = lower(rate_adj), 
        ymax = upper(rate_adj)) +
    scale_color_manual(
      values = raceeth_colors) +
    geom_pointrange(
      position = position_dodge(width = 0.2),
      data = ~ filter(., pop_raceeth != "(all)")) + 
    scale_shape_manual(
      values = set_names(rev(timespan_shapes), timespan_levels)) +
    scale_x_discrete(
      name = NULL) +
    ggtools::scale_y_quantity(
      name = str_glue("Rate per {format_count(rate_per)}"),
      limits = c(0, 1300) / rate_per,
      breaks = seq(0, 1500, by = 250) / rate_per,
      labels = function (x) x * rate_per) +
    guides(
      shape = guide_legend(
        title = "Timespan",
        order = 1,
        override.aes = list(linewidth = 0)),
      color = guide_legend(
        title = "Race/Ethnicity",
        order = 2,
        override.aes = list(linewidth = 0))) +
    geom_vline(
      xintercept = 9.5) +
    fig_description +
    fig_theme 
  
}
```

```{r fig1, fig.dim=c(8, 6), out.width=800, out.height=600}
SFBA_UCD_age_adjusted_data %>% 
  filter(
    pop_raceeth != "(all)") %>% 
  mutate(
    pop_raceeth = fct_reorder(pop_raceeth, -est(rate_adj))) %>% 
  make_figure_by_raceeth() 
```

```{r fig2, fig.dim=c(8, 6), out.width=800, out.height=600}
SFBA_UCD_age_adjusted_data %>% 
  filter(
    timespan == "2011-2020") %>% 
  make_figure_by_raceeth() +
  geom_point( # CI is too small to matter; no need for `pointrange()`
    shape = 9,
    size = 2,
    data = ~ filter(., pop_raceeth == "(all)")) 
```
