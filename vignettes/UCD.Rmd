---
title: "Working with UCD Data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{UCD}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>")
```

```{r setup, include = FALSE}
library(WONDER)    # devtools::install_github("BAAQMD/WONDER")
library(ggtools)   # devtools::install_github("BAAQMD/ggtools")
library(exptools)  # devtools::install_github("BAAQMD/exptools")
library(openxlsx)
```

```{r extdata_path}
extdata_path <- function (...) {
  system.file("extdata", ..., package = "WONDER")
}
```

```{r SFBA_UCD_metadata}
SFBA_UCD_metadata <-
  crossing(
    timespan  = c("2003-2012", "2007-2016", "2011-2020"),
    geography = c("ByCounty", "Regional"),
    age       = c("AllAge", "ByAge5", "ByAge10"),
    variant   = c("Hispanic", "NH-ByRace", "AllRaceEth")) %>% 
  mutate(
    txt_fn    = str_glue("UCD-{timespan}-SFBA-{geography}-{age}-{variant}.txt"),
    txt_path  = map_chr(file.path("UCD", timespan, txt_fn), extdata_path)) %>% 
  filter(
    txt_path != "")
```

```{r SFBA_UCD_data}
SFBA_UCD_age_adjusted_data <-
  SFBA_UCD_metadata %>% 
  filter(age == "AllAge") %>% 
  mutate(data = map(txt_path, import_WONDER_UCD)) %>% 
  unnest(data) 
```

```{r fig_theme}
fig_theme <- 
  theme_simple() +
  theme_gridlines() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1)) +
  theme_remove("axis", c("ticks", "line"), c("x", "y"))
```

```{r raceeth_colors}
raceeth_colors <-
  RACEETH_COLORS %>%          # from the `exptools` package
  rename(NatAm = NatAmer) 

raceeth_colors[["(all)"]] <- gray(0) # black
```

## Charts (Age-Adjusted Rates)

```{r fig_description}
fig_description <-
  labs(
    title = str_glue("Mortality Across the Nine-County Bay Area"),
    subtitle = "Age-adjusted all-cause rates, with 95% confidence intervals",
    caption = str_glue(
      "Accessed at http://wonder.cdc.gov/ucd-icd10.html on Sep 16, 2024 1:44:39 PM",
      str_draft(),
      .sep = "\n"))
```

```{r make_figure_by_raceeth}
make_figure_by_raceeth <- function (.data, ..., rate_per = 100e3) {
  
  timespan_levels <-
    with(.data, sort(unique(timespan)))
  
  timespan_shapes <-
    scale_shape_discrete()$palette(length(timespan_levels))
  
  chart_data <-
    drop_units(.data) %>% 
    replace_na(
      list(
        cnty_name = "(average)", 
        pop_raceeth = "(all)")) %>% 
    mutate(
      cnty_name = fct_reorder(cnty_name, est(rate_adj)) %>% 
        fct_relevel("(average)", after = 9))
  
  chart_data %>% 
    ggplot(...) +
    aes(x = cnty_name, 
        shape = factor(timespan, levels = timespan_levels),
        alpha = I(0.8),
        y = est(rate_adj), 
        color = pop_raceeth,
        ymin = lower(rate_adj), 
        ymax = upper(rate_adj)) +
    scale_color_manual(
      values = raceeth_colors) +
    geom_pointrange(
      position = position_dodge(width = 0.2),
      data = ~ filter(., pop_raceeth != "(all)")) + 
    scale_shape_manual(
      values = set_names(rev(timespan_shapes), timespan_levels)) +
    scale_x_discrete(
      name = NULL) +
    ggtools::scale_y_quantity(
      name = str_glue("Rate per {format_count(rate_per)}"),
      limits = c(0, 1300) / rate_per,
      breaks = seq(0, 1500, by = 250) / rate_per,
      labels = function (x) x * rate_per) +
    guides(
      shape = guide_legend(
        title = "Timespan",
        order = 1,
        override.aes = list(linewidth = 0)),
      color = guide_legend(
        title = "Race/Ethnicity",
        order = 2,
        override.aes = list(linewidth = 0))) +
    geom_vline(
      xintercept = 9.5) +
    fig_description +
    fig_theme 
  
}
```

```{r fig1, fig.dim=c(8, 6), out.width=800, out.height=600}
SFBA_UCD_age_adjusted_data %>% 
  filter(
    pop_raceeth != "(all)") %>% 
  mutate(
    pop_raceeth = fct_reorder(pop_raceeth, -est(rate_adj))) %>% 
  make_figure_by_raceeth() 
```

```{r fig2, fig.dim=c(8, 6), out.width=800, out.height=600}
SFBA_UCD_age_adjusted_data %>% 
  filter(
    timespan == "2011-2020") %>% 
  make_figure_by_raceeth() +
  geom_point( # CI is too small to matter; no need for `pointrange()`
    shape = 9,
    size = 2,
    data = ~ filter(., pop_raceeth == "(all)")) 
```

## Tables (Age-Specific and Age-Adjusted)

For tables of age-specific data, we follow the pattern in the previously shared `CDC_WONDER-mortality_rates-by_age-ContraCosta.xlsx`. 
Up to 20-24 years, we show 5-year strata. 
The remainder are 10-year strata, except for "85+ years" which is open-ended.

```{r SFBA_UCD_age_specific_data}
SFBA_UCD_age_specific_data <- local({
  
  imported_data <-
    SFBA_UCD_metadata %>% 
    filter(age %in% c("ByAge5", "ByAge10")) %>% 
    mutate(data = map(txt_path, import_WONDER_UCD)) %>% 
    mutate(data = map(data, ~ mutate(., pop_age = as.character(pop_age)))) %>% 
    unnest(data)
  
  age5_data <-
    imported_data %>%
    filter(age == "ByAge5") %>% 
    filter(pop_age %in% c(
      "< 1 year",
      "1-4 years",
      "5-9 years",
      "10-14 years",
      "15-19 years",
      "20-24 years"))
  
  age10_data <-
    imported_data %>%
    filter(age == "ByAge10") %>% 
    filter(pop_age %in% c(
      "25-34 years",
      "35-44 years",
      "45-54 years",
      "55-64 years",
      "65-74 years",
      "75-84 years", 
      "85+ years",
      "Not Stated"))
  
  bind_rows(age5_data, age10_data) %>% 
    mutate(pop_age = fct_inorder(pop_age, ordered = TRUE))
  
})
```

```{r xlsx_path}
xlsx_path <- 
  file.path(tempdir(), "UCD-2011-2020-SFBA.xlsx")
```

The following code chunk will have exported data to `r xlsx_path`.
As this is/was in a temporary directory, it may have been deleted by the time you opened this vignette.
If you want a different output location, just change the value of `xlsx_path` and then run the following code yourself.

```{r xlsx_data}
xlsx_data_list <- list()

xlsx_timespan <- "2011-2020"

xlsx_data_list[["age"]] <-
  SFBA_UCD_age_specific_data %>% 
  filter(
    timespan == xlsx_timespan,
    is.na(cnty_name),
    is.na(pop_raceeth)) %>% 
  select(
    timespan, pop_age, rate_crude)

xlsx_data_list[["race"]] <-
  SFBA_UCD_age_adjusted_data %>% 
  filter(
    timespan == xlsx_timespan,
    is.na(cnty_name),
    !is.na(pop_raceeth)) %>% 
  select(
    timespan, pop_raceeth, rate_adj)

xlsx_data_list[["county"]] <-
  SFBA_UCD_age_adjusted_data %>% 
  filter(
    timespan == xlsx_timespan,
    !is.na(cnty_name),
    is.na(pop_raceeth)) %>% 
  select(
    timespan, cnty_name, rate_adj)

xlsx_data_list[["race"]] <-
  SFBA_UCD_age_adjusted_data %>% 
  filter(
    timespan == xlsx_timespan,
    is.na(cnty_name),
    !is.na(pop_raceeth)) %>% 
  select(
    timespan, pop_raceeth, rate_adj)

xlsx_data_list[["age-race"]] <-
  SFBA_UCD_age_specific_data %>% 
  filter(
    timespan == xlsx_timespan,
    is.na(cnty_name),
    !is.na(pop_raceeth)) %>% 
  pivot_wider(
    id_cols = c("timespan", "pop_age"),
    names_from = "pop_raceeth",
    values_from = "rate_crude")

xlsx_data_list[["county-age"]] <-
  SFBA_UCD_age_specific_data %>% 
  filter(
    timespan == xlsx_timespan,
    !is.na(cnty_name),
    is.na(pop_raceeth)) %>% 
  pivot_wider(
    id_cols = c("timespan", "pop_age"),
    names_from = "cnty_name",
    values_from = "rate_crude")

xlsx_data_list[["county-race"]] <-
  SFBA_UCD_age_adjusted_data %>% 
  filter(
    timespan == xlsx_timespan,
    !is.na(cnty_name),
    !is.na(pop_raceeth)) %>% 
  pivot_wider(
    id_cols = c("timespan", "cnty_name"),
    names_from = "pop_raceeth",
    values_from = "rate_adj")

xlsx_data_list[["county-age-race"]] <-
  SFBA_UCD_age_specific_data %>% 
  filter(
    timespan == xlsx_timespan,
    !is.na(cnty_name),
    !is.na(pop_raceeth)) %>% 
  pivot_wider(
    id_cols = c("timespan", "cnty_name", "pop_age"),
    names_from = "pop_raceeth",
    values_from = "rate_crude")

format_xlsx_value <- function (rate, include_CI, na = "—") {
  
  f <- function (x) {
    format_count(x * 1e6)
  }
  
  if (isFALSE(include_CI)) {
    formatted <- str_glue(
      "{f(est(rate))}/M")
  } else {
    formatted <- str_glue(
      "{f(est(rate))}/M",
      "({f(lower(rate))}–{f(upper(rate))})",
      .sep = " ")
  }
  
  formatted <- 
    replace(as.character(formatted), is.na(est(rate)), na)
  
  return(formatted)
  
}

format_xlsx_data <- function (.data) {
  
  recode_name <- function (x) {
    recode(x, timespan = "Timespan", cnty_name = "County", 
           pop_age = "Age", pop_raceeth = "Race/Ethnicity",
           rate_crude = "Crude Rate", rate_adj = "Age-Adjusted Rate")
  }
  
  .data %>% 
    mutate(
      across(
        where(is_ptrg), 
        ~ format_xlsx_value(., include_CI = FALSE))) %>% 
    rename_with(
      recode_name)
  
}

wb <- openxlsx::createWorkbook()
readme_content <- tribble(
  ~ X1, ~ X2, # throwaway names
  "Content", "All-cause mortality rates for the Bay Area. Basis: CDC WONDER, UCD database.",
  "", "Please note that rates cannot simply be averaged between groups or aggregated from more detailed breakdowns.", 
  "", "Please refer to the detailed table (tab/sheet) that already provides the specific breakdown or comparison you need.",
  "", "Confidence intervals are not shown but are available on request (see Contacts, below).",
  "", "If a particular value is not shown, that means there were not enough observations over the relevant time period ",
  "", "to generate a reliable value. The more detailed a breakdown is, the more likely this is to happen.",
  "Contacts", "AIM Division: David Holstius, Yuanyuan Fang, Song Bai",
  "Context", "Request from Greg Nudd, Fall 2024",
  "Last Update", format(Sys.Date()))
addWorksheet(wb, "README")
writeData(wb, "README", readme_content, colNames = FALSE)

for (sheet in names(xlsx_data_list)) {
  addWorksheet(wb, sheet)
  sheet_data <- xlsx_data_list[[sheet]]
  formatted_data <- format_xlsx_data(sheet_data)
  writeData(wb, sheet, formatted_data, withFilter = FALSE)
  value_cols <- unname(which(map_lgl(sheet_data, is_ptrg)))
  value_rows <- 1 + 1:nrow(sheet_data)
  all_rows <- c(1, value_rows)
  align_right <- createStyle(halign = "right")
  setColWidths(wb, sheet, value_cols, "auto")
  setRowHeights(wb, sheet, all_rows, auto_heights(wb, sheet, value_rows)[[2]])
  addStyle(wb, sheet, align_right, rows = all_rows, cols = value_cols, gridExpand = TRUE)
}

#setWindowSize(wb, windowWidth = 100, windowHeight = 100)
saveWorkbook(wb, xlsx_path, overwrite = TRUE)
```
